import {
  Magic,
  this.c-int {c-int},
  this.c-string {c-string, from-c-string},
  this.either {Left, either},
  this.foreign {get-errno},
  this.text {text},
}

data system-error {
| Syscall-Error(c-int)
| Value-Error(text)
}

inline system(a: type): type {
  either(system-error, a)
}

define get-system-error(): system-error {
  Syscall-Error(get-errno())
}

define report-system-error<a>(): system(a) {
  Left(get-system-error())
}

foreign {
  strerror(c-int): pointer,
}

define get-error-message(e: system-error): text {
  match e {
  | Syscall-Error(i) =>
    let c-str = magic external strerror(i) in
    from-c-string(Magic.cast(pointer, &c-string, c-str))
  | Value-Error(message) =>
    message
  }
}
